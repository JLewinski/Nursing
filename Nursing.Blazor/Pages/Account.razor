@page "/account"
@using Nursing.Blazor.Components.Account
@inject NavigationManager Navigation
@inject Nursing.Blazor.Services.SyncService Sync
@inject IJSRuntime JSRuntime
@inject IToastService toastService

<div class="container">
    <div class="row">
        <div class="col-12">
            <h1>Account</h1>
        </div>
    </div>
    
    <!-- Nav tabs -->
    <ul class="nav nav-tabs mt-3" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="sync-tab" data-bs-toggle="tab" data-bs-target="#sync" type="button"
                role="tab" aria-controls="sync" aria-selected="true">
                Sync
            </button>
        </li>
        @if (IsAdmin)
        {
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button"
                    role="tab" aria-controls="register" aria-selected="false">
                    Management
                </button>
            </li>
        }
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button" role="tab"
                aria-controls="data" aria-selected="false">
                Data
            </button>
        </li>
    </ul>

    <!-- Tab panes -->
    <div class="tab-content">
        <div class="tab-pane active" id="sync" role="tabpanel" aria-labelledby="sync-tab">
            <SyncActions />
        </div>
        @if (IsAdmin)
        {
            <div class="tab-pane" id="register" role="tabpanel" aria-labelledby="register-tab">
                <AdminActions />
            </div>
        }
        <div class="tab-pane" id="data" role="tabpanel" aria-labelledby="data-tab">
            <button class="btn btn-outline-danger" @onclick="Delete">Delete</button>
        </div>
    </div>
</div>

@code {
    private bool IsAdmin = false;
    private string username = default!;

    protected override async Task OnInitializedAsync()
    {
        IsAdmin = await Sync.IsAdmin();
        if (!await Sync.IsLoggedIn())
        {
            Navigation.NavigateTo("/login");
        }
    }

    private async Task Logout()
    {
        await Sync.Logout();
        Navigation.NavigateTo("/login");
    }

    [CascadingParameter] private IModalService modalService { get; set; } = null!;

    private async Task Delete()
    {
        ModalParameters parameters = new()
        {
            { "Message", "Are you sure you want to delete your account? This will also delete all your data if another account does not have access." }
        };
        var modal = modalService.Show<Components.Modal.ConfirmationModal>("Delete Account", parameters);
        var modalResult = await modal.Result;
        if (modalResult.Cancelled)
        {
            return;
        }

        var result = await JSRuntime.ShowLoadingModal(async () => await Sync.Delete(await Sync.GetUsername()));
        if (result.success)
        {
            Navigation.NavigateTo("/login");
        }
        toastService.ShowToast(result.message, result.success);
    }
}
